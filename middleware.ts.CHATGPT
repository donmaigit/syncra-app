import { getToken } from "next-auth/jwt";
import createMiddleware from "next-intl/middleware";
import { NextRequest, NextResponse } from "next/server";

// 1. Setup Internationalization
const intlMiddleware = createMiddleware({
  locales: ['ja', 'en'],
  defaultLocale: 'ja',
  localePrefix: 'as-needed'
});

export default async function middleware(req: NextRequest) {
  const url = req.nextUrl;
  const path = url.pathname;
  let hostname = req.headers.get("host") || "";
  
  // Remove port for localhost development (e.g. app.syncra.jp:3000 -> app.syncra.jp)
  hostname = hostname.split(":")[0];

  // 2. SKIP STATIC ASSETS & API (Performance)
  if (
    path.startsWith('/api') || 
    path.startsWith('/_next') || 
    path.includes('.') ||
    path === '/favicon.ico'
  ) {
    return NextResponse.next();
  }

  // --- CONFIGURATION ---
  // Change these for Production
  const APP_DOMAIN = "app.syncra.jp"; 
  const SITE_DOMAIN = "syncra.page"; 

  // --- HELPER: Handle Affiliate Cookies ---
  // If ?ref=code exists, set a cookie so we can attribute the sale later
  const refCode = url.searchParams.get('ref');
  const handleResponse = (res: NextResponse) => {
    if (refCode) {
      res.cookies.set('syncra_affiliate', refCode, { maxAge: 60 * 60 * 24 * 30, path: '/' });
    }
    return res;
  };

  // =========================================================
  // ROUTING LOGIC
  // =========================================================

  // CASE A: DASHBOARD & APP TRAFFIC (app.syncra.jp or donmai.cloud)
  if (hostname === APP_DOMAIN || hostname === `www.${APP_DOMAIN}` || hostname === 'localhost') {
    
    // Protect Dashboard Routes
    const isProtected = /^\/(en|ja)?\/?dashboard/.test(path);
    if (isProtected) {
      const token = await getToken({ req, secret: process.env.NEXTAUTH_SECRET });
      if (!token) {
        const loginUrl = new URL('/login', req.url);
        // loginUrl.searchParams.set('callbackUrl', url.href); // Optional: remember where they were
        return NextResponse.redirect(loginUrl);
      }
    }

    // Pass to next-intl for translation handling
    return handleResponse(intlMiddleware(req));
  }

  // CASE B: USER SUBDOMAINS (user.syncra.page)
  if (hostname.endsWith(`.${SITE_DOMAIN}`)) {
    // Extract "user1" from "user1.syncra.page"
    const subdomain = hostname.replace(`.${SITE_DOMAIN}`, "");
    
    // Rewrite to: /sites/[subdomain]/[path]
    // Example: user1.syncra.page/webinar -> /sites/user1/webinar
    return handleResponse(
      NextResponse.rewrite(new URL(`/sites/${subdomain}${path}`, req.url))
    );
  }

  // CASE C: CUSTOM DOMAINS (mybrand.com)
  // If it's not the App Domain and not the Site Domain, it must be a Custom Domain
  
  // Rewrite to: /sites/[hostname]/[path]
  // We use the full hostname so our page logic knows it's a custom domain
  return handleResponse(
    NextResponse.rewrite(new URL(`/sites/${hostname}${path}`, req.url))
  );
}

export const config = {
  // Match everything except static files
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)']
};